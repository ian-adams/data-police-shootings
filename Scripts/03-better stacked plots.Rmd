---
title: "03-Better Stacked"
author: "Ian Adams"
date: "4/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

# General need
library(tidyverse)
library(readr)
library(here)
library(skimr)
library(ggplot2)
library(lubridate)
library(dplyr)

# Specific need
library(showtext)

```

## Import

Don't forget to pull from the git before start (in the "01-Import.Rmd" file), so as to get fresh data from WAPO.

```{r remedy001, message=FALSE, warning=FALSE, include=FALSE}

here::here("WAPO data-police-shootings")

df <- read_rds(here("Data", "Clean", "WAPO_clean.rds"))

df$date <- ymd(df$date) # format as lubridate var
df$year <- year(df$date) # extract year and create variable year
df$month <- month(df$date, label = TRUE, abbr = TRUE) # extract month and create variable month
df$day <- wday(df$date, label = TRUE, abbr = TRUE) # extract day of week, create variable day

## Change N/A to unknown category
df$armed_bucket <- df$armed_bucket %>%
  fct_explicit_na("unknown")

## Reordering df$armed_bucket
df$armed_bucket <- df$armed_bucket %>%
  fct_relevel(
    "gun", "gun like", "sharp", "blunt", "explosive/chemical",
    "vehicle", "taser", "strange", "unarmed", "unknown"
  )



## Recoding df$armed_bucket into df$armed_bucket_rec
df$armed_small <- df$armed_bucket %>%
  fct_recode(
    "armed" = "strange",
    "armed" = "gun like",
    "armed" = "sharp",
    "armed" = "blunt",
    "armed" = "strange object",
    "armed" = "carjack",
    "armed" = "explosive/chemical",
    "armed" = "gun",
    "armed" = "vehicle",
    "armed" = "taser"
  )





```

## Prelim settings

```{r remedy002}

font_add_google("Fira Sans", "firasans")
showtext_auto()

theme_customs <- theme(
  text = element_text(family = 'firasans', size = 16),
  plot.title.position = 'plot',
  plot.title = element_text(
    face = 'bold', 
    colour = thematic::okabe_ito(8)[6],
    margin = margin(t = 2, r = 0, b = 7, l = 0, unit = "mm")
  ),
)

theme_set(theme_minimal() + theme_customs)


```


## Basic plot

```{r remedy003}

df %>% 
  ggplot(aes(x = year, fill = armed_bucket)) +
  geom_bar()

```

## Create groupings

```{r remedy004}


# Group classes into three groups (to reduce colors to 3)
dat3 <- df %>% 
  mutate(
    year = factor(year),
    class_group = case_when(
      armed_bucket %in% c('gun', 'gun like', 'sharp', 'blunt') ~ "Traditional Threat",
      armed_bucket %in% c('strange', 'taser', 'explosive/chemical', 'vehicle') ~ "Rare Threat",
      armed_bucket %in% 'unarmed' ~ "Unarmed",
      armed_bucket == 'unknown' ~ "Unknown"
    )
  )

## Group 4
# dat4 <- df %>% 
#   mutate(
#     year = factor(year),
#     class_group = case_when(
#       armed_bucket %in% c('gun', 'gun like') ~ "Gun/Gun-like",
#       armed_bucket %in% c('sharp', 'blunt') ~ "Sharp/Blunt",
#       armed_bucket %in% c('strange', 'taser', 'explosive/chemical', 'vehicle') ~ "Other Objects",
#       armed_bucket == 'unarmed' ~ "Unarmed",
#       T ~ "Unknowns"
#     )
#   )
# 
# # Group five
# dat5 <- df %>%
#   mutate(
#     year = factor(year),
#     class_group = case_when(
#       armed_bucket %in% c('gun', 'gun like') ~ "Guns",
#       armed_bucket == c('sharp', 'blunt') ~ "Sharps & Blunts",
#       armed_bucket == c(NA, 'unknown') ~ "Unknowns",
#       armed_bucket == c('vehicle','taser','explosive/chemical') ~ "High Threat",
#       armed_bucket == 'unarmed' ~ "Unarmed",
#       T ~ "Strange"
#     )
#   )
# 
# shades_plt <- dat3 %>% 
#   ggplot(aes(x = year, fill = class_group, alpha = armed_bucket)) +
#   geom_bar() +
#   labs(
#     x = 'Year',
#     y = 'Counts',
#     alpha = 'Class',
#     title = 'Police Shootings by Year \nand Suspect Weapon Type'
#   )
# shades_plt 


```


## Color controls

```{r remedy005}

# Color-blind safe colors
# colors <-  thematic::okabe_ito(4)

colorsb <- c("#0072b2","#d55e00",  "#009e73",  "#f0e442")
# Possible levels of transparency (one for each class)
alpha_max <- 1
alpha_min <- 0.1
alpha_vals <- c(
  seq(alpha_max, alpha_min, length.out = 5), 
  seq(alpha_min, alpha_max, length.out = 6)[-1]
)
alpha_vals
## [1] 1.0 0.9 0.8 0.7 0.8 0.9 1.0

# Tweak previous plot
# shades_plt <- shades_plt +
#   scale_fill_manual(values = colors) +
#   scale_alpha_manual(values = alpha_vals)
# shades_plt


dat3 %>% 
  ggplot(aes(x = year, fill = class_group, alpha = armed_bucket)) +
  geom_bar(col = 'white') + # Add lines for distinction
  scale_fill_manual(values = colorsb) +
  scale_alpha_manual(values = alpha_vals) +
  guides(
    #fill = guide_none(),
    alpha = guide_legend(override.aes = list(fill = colorsb[c(2, 2, 2, 2, 1, 1, 1, 1, 3, 4)]))
  ) +
  labs(
    x = 'Year',
    y = 'Counts',
    alpha = 'Type',
    title = 'Fatal Police Shootings by Year and Suspect Weapon Type',
    fill = 'Category'
  ) 

## These auto save, but the defaults are bad, so export manually

ggsave(filename = here("Output", "year-type-group.pdf"))
ggsave(filename = here("Output", "year-type-group.jpg"))
ggsave(filename = here("Output", "year-type-group.png"), bg="white")

```

## Combining (old version)

```{r remedy006}

# dat3 %>% 
#   ggplot(aes(x = year, fill = class_group, alpha = armed_bucket)) +
#   geom_bar(col = 'white') + # Add lines for distinction
#   scale_fill_manual(values = colors) +
#   scale_alpha_manual(values = alpha_vals) +
#   guides(
#     fill = guide_none(),
#     alpha = guide_legend(override.aes = list(fill = colors[c(2, 2, 2, 2, 1, 1, 1, 1, 3, 4)]))
#   ) +
#   labs(
#     x = 'Year',
#     y = 'Counts',
#     alpha = 'Type',
#     title = 'Fatal Police Shootings by Year and Suspect Weapon Type'
#   )
# 
# ggsave(filename = here("Output", "year-type-group.pdf"))
# ggsave(filename = here("Output", "year-type-group.jpg"))
# ggsave(filename = here("Output", "year-type-group.png"), bg="white")

```







































