---
title: "02-Analyze"
author: "Ian Adams"
date: "3/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(readr)
library(here)

library(ggplot2)
library(lubridate)

library(gghighlight)
library(ggstance)
library(ggalt)

```

## Source new data

This is just running the source file `01-Import V2.R` which pulls the latest WaPo data, merges it, and saves it out.

```{r setup, include=FALSE}

# Source the Wapo data import .R script

#source("~/Library/CloudStorage/GoogleDrive-adams.po@gmail.com/Other computers/My Computer/R/WAPO data-police-shootings/Scripts/01-Import V2.R")

source("Scripts/01-Import V2.R")

df_all$date <- ymd(df_all$date) # format as lubridate var
df_all$year <- lubridate::year(df_all$date) # extract year and create variable year
df_all$month <- month(df_all$date, label = TRUE, abbr = TRUE) # extract month and create variable month
df_all$day <- wday(df_all$date, label = TRUE, abbr = TRUE) # extract day of week, create variable day

```

## US, region, and state population 2010-2019

```{r}

library(readxl)
library(stringr)


## First try - just uses 2019 population data for every rate calculation - obviously wrong since pop growing, but we don't have population data after 2019, so this works.
state_pop <- read_excel(here("Data","Raw","population_state_region_2010-2019.xlsx"))

# Create a state abbreviation mapping
state_mapping <- data.frame(full_name = state.name, abbreviation = state.abb)

# Clean the state_pop dataset
state_pop_clean <- state_pop %>%
  filter(!name %in% c("United States", "Northeast", "Midwest", "South", "West", "Puerto Rico")) %>%
  mutate(state = gsub("^\\.", "", name)) %>%
  left_join(state_mapping, by = c("state" = "full_name")) %>%
  select(abbreviation, population = `2019`)

# Aggregate the police_shootings dataset by state and year
police_shootings_agg <- df_all %>%
  group_by(state, year) %>%
  summarise(total_shootings = n()) %>%
  ungroup()

# Join the two datasets
combined_data <- left_join(police_shootings_agg, state_pop_clean, by = c("state" = "abbreviation"))

# Calculate the rate of police shootings per 1 million residents for each year
combined_data <- combined_data %>%
  mutate(rate_per_million = (total_shootings / population) * 1e6)

# Spread the data so each year is a separate column
combined_data_spread <- combined_data %>%
  select(-total_shootings) %>%
  spread(year, rate_per_million)

# Display the resulting dataset
glimpse(combined_data_spread)

## Alternative method - use the right population data for each year, but will only do 2015-2019 because we don't have pop data after 2019


# Create a state abbreviation mapping
state_mapping <- data.frame(full_name = state.name, abbreviation = state.abb)

# Clean and reshape the state_pop dataset
state_pop_long <- state_pop %>%
  filter(!name %in% c("United States", "Northeast", "Midwest", "South", "West", "Puerto Rico")) %>%
  mutate(state = gsub("^\\.", "", name)) %>%
  left_join(state_mapping, by = c("state" = "full_name")) %>%
  select(abbreviation, everything(), -name) %>%
  gather(year, population, `2010`:`2019`) %>%
  mutate(year = as.integer(year))

# Aggregate the police_shootings dataset by state and year
police_shootings_agg <- df_all %>%
  filter(year >= 2015 & year <= 2023) %>%
  group_by(state, year) %>%
  summarise(total_shootings = n()) %>%
  ungroup()

# Join the two datasets
combined_data <- left_join(police_shootings_agg, state_pop_long, by = c("state" = "abbreviation", "year"))

# Calculate the rate of police shootings per 1 million residents for each year
combined_data <- combined_data %>%
  mutate(rate_per_million = (total_shootings / population) * 1e6)

# Spread the data so each year is a separate column
combined_data_spread <- combined_data %>%
  select(-total_shootings) %>%
  spread(year, rate_per_million)

# Display the resulting dataset
glimpse(combined_data_spread)


```


## Cumulative line plots like jnixy's

```{r remedy007}

# Load the required packages
library(ggthemes)
library(extrafont)
library(ggrepel)

df <- df_all

# Shape data

shootings_data <- df %>%
  arrange(date) %>%
  mutate(year = as.numeric(format(date, "%Y"))) %>%
  group_by(year, date) %>%
  summarize(daily_count = n()) %>%
  ungroup()

shootings_data <- shootings_data %>%
  group_by(year) %>%
  mutate(cum_count = cumsum(daily_count)) %>%
  ungroup()

# Load fonts
loadfonts(device = "win", quiet = TRUE)

# Store the current date in a variable
current_date <- Sys.Date()
formatted_date <- format(current_date, "%B %d, %Y")

## Calculate mean data
mean_shootings_data <- shootings_data %>%
  filter(year < 2023) %>%
  mutate(formatted_date = format(date, "%m-%d")) %>%
  group_by(formatted_date) %>%
  summarize(mean_cum_count = mean(cum_count), .groups = 'drop') %>%
  mutate(date = as.Date(paste0("2022-", formatted_date), format = "%Y-%m-%d"))

# Plot the figure
ggplot(shootings_data, aes(x = format(date, "%m-%d"), y = cum_count, group = factor(year))) +
  geom_point(aes(color = factor(year)), alpha = 0.5, size = 1) +
  gghighlight(year == 2023, use_direct_label = FALSE) +
  scale_x_discrete(name = "Month",
                   breaks = format(seq(as.Date("2022-01-01"), as.Date("2022-12-31"), by = "1 month"), "%m-%d"),
                   labels = format(seq(as.Date("2022-01-01"), as.Date("2022-12-31"), by = "1 month"), "%b"),
                   expand = c(0.01, 0.9)) + # Expanding the x-axis limits
  scale_y_continuous(name = "Cumulative Count of Deaths", limits = c(0, 1150)) +
  theme_tufte() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "none",
        text = element_text(family = "Arial", color = "black"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.text.y = element_text(angle = 0, hjust = 0.5),
        plot.title = element_text(size = 14, hjust = 0, face = "bold"),
        plot.title.position = "plot",
        plot.caption = element_text(size = 10, hjust = 1)) +
  geom_text_repel(data = shootings_data %>% group_by(year) %>% filter(date == max(date)),
                  aes(x = format(date, "%m-%d"), y = cum_count, label = year),
                  size = 3) +
  labs(title = "Cumulative U.S. Police Lethal Shootings by Year",
       subtitle = paste("as of", formatted_date),
       caption = "Source: Ian T. Adams \ndata via Washington Post")



## Save it
ggsave(filename = here("Output", "cumulative_daily_count.jpg"), height = 8, width = 8)

```

## Armed Status Breakdown 


```{r remedy002, include=FALSE}

ggplot(df, aes(x = armed_with)) +
  geom_bar(fill = "#619CFF") +
  labs(title = "Weapons used in police shootings",
       x = "Armed with",
       y = "Count") +
  theme_minimal()

ggsave(p3, filename = here("Output", "time_armed_threat.jpg"))

```


## Most Common Armed Weapons

```{r remedy003}

temp <- table(df$armed_bucket) / nrow(df) * 100
temp <- sort(temp, decreasing = TRUE)
temp <- round(temp, digits = 2)
temp
```
## Gender Breakdowns

```{r remedy004}
table(df$gender) / nrow(df) * 100

```

## Race Breakdowns

```{r remedy005}

## Percentage by race
temp <- table(df$race_rec) / nrow(df) * 100
temp <- sort(temp)
temp <- round(temp, digits = 2)
temp

## Barplot by race

#Make "NA" into an explicit factor level
df$race_rec <- df$race_rec %>%
  fct_explicit_na("Unknown")

df$race_rec <- factor(df$race_rec,
                         levels = names(sort(table(df$race_rec), 
                                             decreasing = TRUE)))



ggplot(df, aes(x = race)) + 
  geom_bar() +
  geom_text(aes(label = sprintf("%0.2f", round(..count..)/sum(..count..),digits=2)), stat = "count", hjust = 0, colour = "black")

## Or flipped and with proportion

ggplot(df, aes(x = race)) + 
  geom_bar() +
  coord_flip() +
  geom_text(aes(label = sprintf("%0.2f", round(..count..)/sum(..count..),digits=2)), stat = "count", hjust = 0, colour = "black")

```

## Age Breakdowns

```{r remedy006}
## Histogram
ggplot(df, aes(x = age)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)))

## Density

ggplot(df, aes(x = age)) + 
  geom_density()

## Simple Stat Count

ggplot(df, aes(x = age)) + 
  stat_count(aes(y = (..count..)/sum(..count..)))

```



## Over time with population

```{r remedy007}

#library(tidycensus)

# set your Census API key here
#census_api_key("e0ec52f1c5358231d666ff8dce8c15eb40002b78", install = TRUE, overwrite = TRUE)

#Manually create population tibble
pop_data <- tribble(
  ~year, ~estimate,
  2015, 324607776,
  2016, 327210198,
  2017, 329791231,
  2018, 332140037,
  2019, 334319671,
  2020, 335942003,
  2021, 336997624,
  2022, 338289857
)

pop_data <- pop_data %>% mutate(NAME = "United States")

df2022 <- df_all %>%
  filter(year >= 2015 & year <= 2022)

# join with events data and calculate normalized events
events_normalized <- df2022 %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(total_events = n()) %>%
  left_join(pop_data, by = "year") %>%
  mutate(events_per_capita = total_events / estimate * 1000000)

ggplot(events_normalized, aes(x = year, y = events_per_capita)) +
  geom_bar(stat = "identity") +
  labs(title = "US Police Shooting Deaths per 1,000,000 people by year") +
  labs(y="Fatal shootings per capita") +
  labs(caption = "Source: Washington Post & United Nations - World Population Prospects")

```

## Add uncertainty

```{r remedy008}


# Define color palette for the bars
colors <- c("#d3d3d3", "#ff7f0e", "#1f77b4", "#2ca02c", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f")

# Join with events data and calculate normalized events
events_normalized <- df2022 %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(total_events = n()) %>%
  left_join(pop_data, by = "year") %>%
  mutate(
    events_per_capita = total_events / estimate * 1000000,
    se = events_per_capita / sqrt(0.92 * total_events)
  )

# Plot the bar chart with error bars and labels
ggplot(events_normalized, aes(x = year, y = events_per_capita)) +
  geom_bar(stat = "identity", color = "white", size = 0.2, fill="#7777AB") +
  #scale_fill_manual(values = colors) +
  geom_errorbar(aes(ymin = events_per_capita, ymax = events_per_capita + 1.96 * se), 
                 width = 0.2, color = "black", size = 0.8) +
  geom_text(aes(label = sprintf("%.2f", events_per_capita), y = events_per_capita/2), vjust = 1.5) +
  labs(title = "US Police Shooting Deaths per 1,000,000 people by year") +
  labs(subtitle = "assuming 92% counting accuracy") +
  labs(y = "Fatal shootings per capita") +
  labs(x = "Year") +
  labs(caption = "Source: Washington Post and United Nations - World Population Prospects \n Courtesy: Ian Adams and Justin Nix") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "none"
  ) +
  scale_x_continuous(breaks = events_normalized$year, labels = events_normalized$year)


ggsave(filename = here("Output", "pop_normal_error.jpg"), height = 5, width = 8)

```

## Top 15 States

```{r, fig.height=9, fig.width=9}
stateinfo <- df %>% group_by(state) %>% summarise(n = n()) %>% 
        arrange(desc(n)) %>% top_n(15) %>% 
        mutate(state = factor(state, levels = rev(unique(state))))

ggplot(stateinfo) +
  aes(x = state, fill = state, weight = n) +
  geom_bar() +
  scale_fill_manual(
    values = c(PA = "#A6CEE3",
    LA = "#3B8ABE",
    NM = "#72B29C",
    MO = "#84C868",
    OH = "#4F9F3B",
    WA = "#EC9A91",
    TN = "#E93E3F",
    OK = "#F06C45",
    NC = "#FDAC4F",
    CO = "#FB820F",
    GA = "#D1AAB7",
    AZ = "#8C66AF",
    FL = "#A99099",
    TX = "#EEDB80",
    CA = "#B15928")
  ) +
  labs(
    y = "Number of deaths",
    title = "Top 15 States for Police Fatal Shootings",
    subtitle = "2015-2022",
    caption = "Washington Post data"
  ) +
  coord_flip() +
  hrbrthemes::theme_ipsum_tw() +
  theme(legend.position = "none")
```


## Armed Status? (top 15 reported categories)

```{r}

df$armed_bucket <- df$armed_bucket %>%
  fct_explicit_na("unknown")

armedinfo <- df %>% group_by(armed_bucket) %>% summarise(n = n()) %>% 
        arrange(desc(n)) %>% top_n(15) %>% 
        mutate(armed = factor(armed_bucket, levels = rev(unique(armed_bucket))))

## For testing only, drop all "unknowns"
# armedinfo$armed <- armedinfo$armed %>%
#   fct_recode(
#     NULL = "unknown"
#   )


## add percentage column for labeling
armedinfo <- armedinfo %>% dplyr::mutate(perc = scales::percent(n / sum(n), accuracy = .1, trim = FALSE)) %>% drop_na()



## Plot it
p1 <- ggplot(data = armedinfo, aes(x = n, y = armed)) +
  geom_barh(stat = "identity", aes(fill = n)) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_gradient(low = "royalblue3", high = "navyblue") +
  labs(
    y = NULL,
    x = "Number of deaths",
    title = "Top Suspect Weapon Types in Police Fatal Shootings",
    subtitle = "2015-2022",
    caption = "Washington Post data"
  ) +
  geom_text(aes(label = perc),
            hjust = -.25,
            size = 4, fontface = "bold", family = "Fira Sans")

p1 + coord_cartesian(xlim = c(0, 4800), clip = "off")

## Save it
ggsave(filename = here("Output", "top15_suspect-weapon-type.jpg"))







``` 

### Was the Person Killed Fleeing?

```{r}
df$flee_bucket <- df$flee_bucket %>%
  fct_explicit_na("Unknown")

ggplot(data = df, aes(y = flee_bucket)) + 
        geom_barh(aes(fill = ..count..)) +
        theme_minimal(base_size = 13) +
        theme(legend.position = "none") +
        scale_x_continuous(expand=c(0,0)) +
        scale_fill_gradient(low = "royalblue3", high = "navyblue") +
        labs(y = NULL, x = "Number of deaths")
```




## Compare Axon stock price with police killings

```{r remedy010}



```






























