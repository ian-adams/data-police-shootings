---
title: "02-Analyze"
author: "Ian Adams"
date: "3/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(readr)

library(here)
library(skimr)
library(ggplot2)
library(lubridate)
library(dplyr)

library(ggstance)
library(ggalt)
```

## Import

Don't forget to pull from the git before start (in the "01-Import.Rmd" file), so as to get fresh data from WAPO.

```{r remedy001, message=FALSE, warning=FALSE, include=FALSE}

here::here("WAPO data-police-shootings")

df <- read_rds(here("Data", "Clean", "WAPO_clean.rds"))

df$date <- ymd(df$date) # format as lubridate var
df$year <- year(df$date) # extract year and create variable year
df$month <- month(df$date, label = TRUE, abbr = TRUE) # extract month and create variable month
df$day <- wday(df$date, label = TRUE, abbr = TRUE) # extract day of week, create variable day

```

## Armed Status Breakdown 

This may no longer be needed - check new armed status indicators from V2 WAPO
```{r remedy002, include=FALSE}

## Fix "claimed" armed status to "unarmed" and equate "unknown" and "undetermined"
df$armed_bucket <- df$armed_bucket %>%
  fct_recode(
    "unarmed" = "claim",
    "unknown" = "undetermined"
  )

## Recoding df$armed_bucket into df$armed_bucket_rec
df$armed_small <- df$armed_bucket %>%
  fct_recode(
    "armed" = "strange",
    "armed" = "gun like",
    "armed" = "sharp",
    "armed" = "blunt",
    "armed" = "strange object",
    "armed" = "carjack",
    "armed" = "explosive/chemical",
    "armed" = "gun",
    "armed" = "vehicle",
    "armed" = "taser"
  )

## Armed Status by Race
p1 <- df %>% 
  na.omit(race_rec) %>%
  ggplot(aes(x = race_rec, fill = armed_small)) +
  geom_bar(position = "stack")

## Armed status by gender

p2 <- df %>% 
  na.omit(gender) %>%
  ggplot(aes(x = gender, fill = armed_small)) +
  geom_bar(position = "stack")

## Shootings by armed and threat status

p3 <- df %>%
 filter(!is.na(armed_bucket)) %>%
 ggplot() +
  aes(x = armed_small, fill = threat) +
  geom_bar(position = "stack") +
  scale_fill_hue(direction = 1) +
  labs(
    y = "Number of Shootings",
    x = NULL,
    title = "Police Fatal Shootings",
    subtitle = "2015-2022, by armed and threat status",
    caption = "Data from Washington Post Police Shootings Database"
  ) +
  hrbrthemes::theme_ipsum_tw()

ggsave(p3, filename = here("Output", "time_armed_threat.jpg"))

```


## Most Common Armed Weapons

```{r remedy003}

temp <- table(df$armed_bucket) / nrow(df) * 100
temp <- sort(temp, decreasing = TRUE)
temp <- round(temp, digits = 2)
temp
```
## Gender Breakdowns

```{r remedy004}
table(df$gender) / nrow(df) * 100

```

## Race Breakdowns

```{r remedy005}

## Percentage by race
temp <- table(df$race_rec) / nrow(df) * 100
temp <- sort(temp)
temp <- round(temp, digits = 2)
temp

## Barplot by race

#Make "NA" into an explicit factor level
df$race_rec <- df$race_rec %>%
  fct_explicit_na("Unknown")

df$race_rec <- factor(df$race_rec,
                         levels = names(sort(table(df$race_rec), 
                                             decreasing = TRUE)))



ggplot(df, aes(x = race)) + 
  geom_bar() +
  geom_text(aes(label = sprintf("%0.2f", round(..count..)/sum(..count..),digits=2)), stat = "count", hjust = 0, colour = "black")

## Or flipped and with proportion

ggplot(df, aes(x = race)) + 
  geom_bar() +
  coord_flip() +
  geom_text(aes(label = sprintf("%0.2f", round(..count..)/sum(..count..),digits=2)), stat = "count", hjust = 0, colour = "black")

```

## Age Breakdowns

```{r remedy006}
## Histogram
ggplot(df, aes(x = age)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)))

## Density

ggplot(df, aes(x = age)) + 
  geom_density()

## Simple Stat Count

ggplot(df, aes(x = age)) + 
  stat_count(aes(y = (..count..)/sum(..count..)))

```


## Plotting over time

```{r, fig.height=7, fig.width=9}

# assuming your tibble is called `df`
events_summarized <- df %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(total_events = n())

ggplot(events_summarized, aes(x = year, y = total_events)) +
  geom_bar(stat = "identity") +
  labs(title = "Total events by year")



## Or some earlier, harder ways (but maybe prettier? can fix above)
df$dummy <- 1
df$month_year <- floor_date(df$date, unit = "month")
df$year       <- year(df$date)


monthly_shootings <- df %>%
  group_by(month_year) %>% 
  summarize(dummy = sum(dummy))

#head(monthly_shootings)

## Plot shootings by month
ggplot(monthly_shootings, aes(x = month_year,
                              y = dummy)) +
  geom_line()

## Shootings per month overall
ggplot(data = df, aes(x = month(date, label = TRUE))) + 
        geom_bar(aes(fill = ..count..)) +
        theme_minimal() +
        theme(legend.position = "none") +
        scale_y_continuous(expand=c(0,0)) +
        scale_fill_gradient(low = "royalblue3", high = "navyblue") +
        labs(x = NULL, y = "Number of deaths")

## Plot shootings by year
yearly_shootings <- df %>%
  group_by(year) %>% 
  summarize(dummy = sum(dummy))

ggplot(yearly_shootings, aes(x = year, 
                             y = dummy)) +
  geom_line()
## OR

ggplot(data = df, aes(x = date)) + 
        geom_histogram(aes(fill = ..count..), bins = 25) +
        theme_minimal() +
        theme(legend.position = "none") +
        scale_fill_gradient(low = "royalblue3", high = "navyblue") +
        labs(x = NULL, y = "Number of deaths")


## Weekday analysis

ggplot(data = df, aes(x = wday(date, label = TRUE))) + 
        geom_bar(aes(fill = ..count..)) +
        theme_minimal() +
        theme(legend.position = "none") +
        scale_y_continuous(expand=c(0,0)) +
        scale_fill_gradient(low = "royalblue3", high = "navyblue") +
        labs(x = NULL, y = "Number of deaths")

```

## Over time with population

```{r remedy007}

#library(tidycensus)

# set your Census API key here
#census_api_key("e0ec52f1c5358231d666ff8dce8c15eb40002b78", install = TRUE, overwrite = TRUE)

#Manually create population tibble
pop_data <- tribble(
  ~year, ~estimate,
  2015, 324607776,
  2016, 327210198,
  2017, 329791231,
  2018, 332140037,
  2019, 334319671,
  2020, 335942003,
  2021, 336997624,
  2022, 338289857
)

pop_data <- pop_data %>% mutate(NAME = "United States")

df2022 <- df %>%
  filter(year >= 2015 & year <= 2022)

# join with events data and calculate normalized events
events_normalized <- df2022 %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(total_events = n()) %>%
  left_join(pop_data, by = "year") %>%
  mutate(events_per_capita = total_events / estimate * 1000000)

ggplot(events_normalized, aes(x = year, y = events_per_capita)) +
  geom_bar(stat = "identity") +
  labs(title = "US Police Shooting Deaths per 1,000,000 people by year") +
  labs(y="Fatal shootings per capita") +
  labs(caption = "Source: Washington Post & United Nations - World Population Prospects")

```

## Add uncertainty

```{r remedy008}


# Define color palette for the bars
colors <- c("#d3d3d3", "#ff7f0e", "#1f77b4", "#2ca02c", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f")

# Join with events data and calculate normalized events
events_normalized <- df2022 %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(total_events = n()) %>%
  left_join(pop_data, by = "year") %>%
  mutate(
    events_per_capita = total_events / estimate * 1000000,
    se = events_per_capita / sqrt(0.92 * total_events)
  )

# Plot the bar chart with error bars and labels
ggplot(events_normalized, aes(x = year, y = events_per_capita)) +
  geom_bar(stat = "identity", color = "white", size = 0.2, fill="#7777AB") +
  #scale_fill_manual(values = colors) +
  geom_errorbar(aes(ymin = events_per_capita, ymax = events_per_capita + 1.96 * se), 
                 width = 0.2, color = "black", size = 0.8) +
  geom_text(aes(label = sprintf("%.2f", events_per_capita), y = events_per_capita/2), vjust = 1.5) +
  labs(title = "US Police Shooting Deaths per 1,000,000 people by year") +
  labs(subtitle = "assuming 92% counting accuracy") +
  labs(y = "Fatal shootings per capita") +
  labs(x = "Year") +
  labs(caption = "Source: Washington Post and United Nations - World Population Prospects \n Courtesy: Ian Adams and Justin Nix") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "none"
  ) +
  scale_x_continuous(breaks = events_normalized$year, labels = events_normalized$year)


ggsave(filename = here("Output", "pop_normal_error.jpg"), height = 5, width = 8)

```

## Top 15 States

```{r, fig.height=9, fig.width=9}
stateinfo <- df %>% group_by(state) %>% summarise(n = n()) %>% 
        arrange(desc(n)) %>% top_n(15) %>% 
        mutate(state = factor(state, levels = rev(unique(state))))

ggplot(stateinfo) +
  aes(x = state, fill = state, weight = n) +
  geom_bar() +
  scale_fill_manual(
    values = c(PA = "#A6CEE3",
    LA = "#3B8ABE",
    NM = "#72B29C",
    MO = "#84C868",
    OH = "#4F9F3B",
    WA = "#EC9A91",
    TN = "#E93E3F",
    OK = "#F06C45",
    NC = "#FDAC4F",
    CO = "#FB820F",
    GA = "#D1AAB7",
    AZ = "#8C66AF",
    FL = "#A99099",
    TX = "#EEDB80",
    CA = "#B15928")
  ) +
  labs(
    y = "Number of deaths",
    title = "Top 15 States for Police Fatal Shootings",
    subtitle = "2015-2022",
    caption = "Washington Post data"
  ) +
  coord_flip() +
  hrbrthemes::theme_ipsum_tw() +
  theme(legend.position = "none")
```


## Armed Status? (top 15 reported categories)

```{r}

df$armed_bucket <- df$armed_bucket %>%
  fct_explicit_na("unknown")

armedinfo <- df %>% group_by(armed_bucket) %>% summarise(n = n()) %>% 
        arrange(desc(n)) %>% top_n(15) %>% 
        mutate(armed = factor(armed_bucket, levels = rev(unique(armed_bucket))))

## For testing only, drop all "unknowns"
# armedinfo$armed <- armedinfo$armed %>%
#   fct_recode(
#     NULL = "unknown"
#   )


## add percentage column for labeling
armedinfo <- armedinfo %>% dplyr::mutate(perc = scales::percent(n / sum(n), accuracy = .1, trim = FALSE)) %>% drop_na()



## Plot it
p1 <- ggplot(data = armedinfo, aes(x = n, y = armed)) +
  geom_barh(stat = "identity", aes(fill = n)) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_gradient(low = "royalblue3", high = "navyblue") +
  labs(
    y = NULL,
    x = "Number of deaths",
    title = "Top Suspect Weapon Types in Police Fatal Shootings",
    subtitle = "2015-2022",
    caption = "Washington Post data"
  ) +
  geom_text(aes(label = perc),
            hjust = -.25,
            size = 4, fontface = "bold", family = "Fira Sans")

p1 + coord_cartesian(xlim = c(0, 4800), clip = "off")

## Save it
ggsave(filename = here("Output", "top15_suspect-weapon-type.jpg"))







``` 

### Was the Person Killed Fleeing?

```{r}
df$flee_bucket <- df$flee_bucket %>%
  fct_explicit_na("Unknown")

ggplot(data = df, aes(y = flee_bucket)) + 
        geom_barh(aes(fill = ..count..)) +
        theme_minimal(base_size = 13) +
        theme(legend.position = "none") +
        scale_x_continuous(expand=c(0,0)) +
        scale_fill_gradient(low = "royalblue3", high = "navyblue") +
        labs(y = NULL, x = "Number of deaths")
```

## Basic line plots

```{r remedy007}

df <- df %>% mutate(row_number= 1:n())

yearly_counts <- df %>%
  count(year, armed_bucket)

df %>% ggplot(aes(x=date, y=row_number)) +
  geom_line(stat = "identity")
  
yearly_counts %>% ggplot(aes(x = year, y = n, color = armed_bucket)) +
    geom_line()


